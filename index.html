<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="í™‹ì¹´ì´ë„ ì—¬í–‰">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#DFF0FB">
<meta name="description" content="ì¤€ì˜ & ì •ì›ì˜ í™‹ì¹´ì´ë„ ì—¬í–‰ 2026">
<title>í™‹ì¹´ì´ë„ ì—¬í–‰ 2026 â„ï¸</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>â„ï¸</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23DFF0FB' width='100' height='100' rx='20'/><text x='50' y='58' text-anchor='middle' font-size='55'>â„ï¸</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSS VARIABLES â€” THEME SYSTEM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  /* Light theme (default) */
  --bg-gradient-1: #DFF0FB;
  --bg-gradient-2: #EDE7F3;
  --bg-gradient-3: #F8F5FA;
  --glass-bg: rgba(255,255,255,.55);
  --glass-border: rgba(135,206,250,.3);
  --text-primary: #2C5F8A;
  --text-secondary: #8BAFC8;
  --text-accent: #5B8DB8;
  --text-muted: #A8C0D4;
  --text-label: #6B9CC7;
  --text-link: #4A8ABF;
  --btn-gradient-1: #7BC0F5;
  --btn-gradient-2: #4A9CD9;
  --btn-shadow: rgba(74,154,217,.3);
  --btn-sec-bg: rgba(135,206,250,.2);
  --btn-sec-border: rgba(135,206,250,.3);
  --input-border: #D4E8F5;
  --input-bg: #fff;
  --card-blue-bg: #E8F4FD;
  --card-orange-bg: #FFF0E0;
  --card-green-bg: #E8F5E9;
  --card-red-bg: #FFEBEE;
  --card-special-bg: rgba(129,199,132,.1);
  --card-special-border: rgba(129,199,132,.25);
  --outfit-top-bg1: #E8F4FD;
  --outfit-top-bg2: #D4ECFC;
  --outfit-bottom-bg1: #F0E6F6;
  --outfit-bottom-bg2: #E8D8F0;
  --outfit-top-label: #7BAFD4;
  --outfit-top-text: #3A7CA5;
  --outfit-bottom-label: #A07DBF;
  --outfit-bottom-text: #6D4A8A;
  --todo-unchecked-bg: rgba(255,255,255,.55);
  --todo-unchecked-border: rgba(135,206,250,.2);
  --todo-checked-bg: rgba(135,206,250,.12);
  --todo-checked-border: rgba(135,206,250,.3);
  --checkbox-border: #A8D4F0;
  --checkbox-bg: #fff;
  --progress-track: #E8F0F5;
  --couple-badge-bg: #FFE4EC;
  --couple-badge-text: #D4668A;
  --color-over: #E05555;
  --color-under: #4A9A5A;
  --color-est: #E8A040;
  --color-orange: #D4882A;
  --color-free: #B0D0E8;
  --del-normal-bg: #FFEBEE;
  --del-normal-text: #D44A4A;
  --del-confirm-bg: #D44A4A;
  --snow-color: #fff;
  --snow-opacity-base: 0.12;
  --meta-color: #7BAFD4;
  --spending-border: rgba(135,206,250,.1);
  --tab-bg: rgba(255,255,255,.5);
  --tab-border: rgba(135,206,250,.3);
  --tab-text: #5B8DB8;
  --toast-bg: rgba(255,255,255,.95);
  --toast-shadow: rgba(0,0,0,.1);
}

[data-theme="dark"] {
  --bg-gradient-1: #0F1923;
  --bg-gradient-2: #141E2B;
  --bg-gradient-3: #1A2535;
  --glass-bg: rgba(30,45,65,.65);
  --glass-border: rgba(80,140,200,.2);
  --text-primary: #C8E0F4;
  --text-secondary: #6A8FAA;
  --text-accent: #7AACCE;
  --text-muted: #4A6A82;
  --text-label: #5E92B8;
  --text-link: #6AACCF;
  --btn-gradient-1: #3A8AD0;
  --btn-gradient-2: #2A6AAA;
  --btn-shadow: rgba(40,100,180,.3);
  --btn-sec-bg: rgba(60,120,180,.15);
  --btn-sec-border: rgba(60,120,180,.25);
  --input-border: #2A4A65;
  --input-bg: #1A2E42;
  --card-blue-bg: rgba(40,80,130,.3);
  --card-orange-bg: rgba(120,80,30,.25);
  --card-green-bg: rgba(40,100,50,.2);
  --card-red-bg: rgba(120,40,40,.2);
  --card-special-bg: rgba(60,130,70,.15);
  --card-special-border: rgba(60,130,70,.25);
  --outfit-top-bg1: rgba(40,80,130,.3);
  --outfit-top-bg2: rgba(35,70,115,.4);
  --outfit-bottom-bg1: rgba(80,50,110,.3);
  --outfit-bottom-bg2: rgba(70,40,100,.4);
  --outfit-top-label: #5E92B8;
  --outfit-top-text: #80BBD8;
  --outfit-bottom-label: #9070B0;
  --outfit-bottom-text: #B090D0;
  --todo-unchecked-bg: rgba(30,50,70,.5);
  --todo-unchecked-border: rgba(60,120,180,.15);
  --todo-checked-bg: rgba(40,80,130,.2);
  --todo-checked-border: rgba(60,120,180,.2);
  --checkbox-border: #3A7AAA;
  --checkbox-bg: #1A2E42;
  --progress-track: #1E3448;
  --couple-badge-bg: rgba(180,70,100,.25);
  --couple-badge-text: #D080A0;
  --color-over: #E06060;
  --color-under: #60B070;
  --color-est: #D0A050;
  --color-orange: #D09040;
  --color-free: #4A6A82;
  --del-normal-bg: rgba(180,50,50,.2);
  --del-normal-text: #E07070;
  --del-confirm-bg: #C04040;
  --snow-color: rgba(200,220,240,.6);
  --snow-opacity-base: 0.06;
  --meta-color: #5E8AAA;
  --spending-border: rgba(60,120,180,.1);
  --tab-bg: rgba(30,50,70,.5);
  --tab-border: rgba(60,120,180,.2);
  --tab-text: #6A9ABB;
  --toast-bg: rgba(25,40,55,.95);
  --toast-shadow: rgba(0,0,0,.3);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET & BASE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}
html,body{overscroll-behavior:none;overflow-x:hidden}
body{
  font-family:'Noto Sans KR','Apple SD Gothic Neo','Malgun Gothic','Segoe UI','Apple Color Emoji','Segoe UI Emoji','Noto Color Emoji',sans-serif;
  min-height:100vh;min-height:100dvh;
  background:linear-gradient(180deg,var(--bg-gradient-1) 0%,var(--bg-gradient-2) 40%,var(--bg-gradient-3) 100%);
  color:var(--text-primary);
  padding:0;
  -webkit-font-smoothing:antialiased;
  transition:background .3s,color .3s;
}
::-webkit-scrollbar{display:none}
input,select,button{font-family:inherit;-webkit-appearance:none;appearance:none}
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
input[type=number]{-moz-appearance:textfield}

/* Snowflakes */
.snow-wrap{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
.snowflake{position:absolute;top:-10px;border-radius:50%;background:var(--snow-color)}

/* Layout */
.app{position:relative;z-index:1;padding:16px 16px calc(env(safe-area-inset-bottom,20px) + 20px);padding-top:max(env(safe-area-inset-top,16px),16px);max-width:500px;margin:0 auto;min-height:100vh;min-height:100dvh;touch-action:pan-y}

/* Glass Card */
.glass{background:var(--glass-bg);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-radius:16px;border:1px solid var(--glass-border);transition:background .3s,border-color .3s}

/* Header */
.header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px}
.header-left{flex:1}
.header-right{display:flex;gap:6px;align-items:center;flex-shrink:0}
.meta{font-size:10px;color:var(--meta-color);font-weight:600;letter-spacing:2px}
.title{font-size:22px;font-weight:900;color:var(--text-primary);margin-top:2px}
.sub{font-size:11px;color:var(--text-secondary);margin-top:2px}

/* Buttons */
.btn-primary{background:linear-gradient(135deg,var(--btn-gradient-1),var(--btn-gradient-2));color:#fff;border:none;border-radius:12px;padding:8px 14px;font-size:12px;font-weight:700;cursor:pointer;box-shadow:0 4px 12px var(--btn-shadow);touch-action:manipulation;transition:transform .1s}
.btn-primary:active{transform:scale(.95)}
.btn-secondary{background:var(--btn-sec-bg);border:1px solid var(--btn-sec-border);border-radius:8px;padding:6px 12px;font-size:11px;font-weight:600;color:var(--text-link);cursor:pointer;touch-action:manipulation;transition:background .3s}
.btn-icon{background:var(--btn-sec-bg);border:1px solid var(--btn-sec-border);border-radius:10px;padding:6px 10px;font-size:14px;cursor:pointer;touch-action:manipulation;transition:background .2s;line-height:1}
.btn-icon:active{transform:scale(.92)}

/* Clocks */
.clocks{display:flex;gap:10px;margin-bottom:12px}
.clock-card{flex:1;text-align:center;padding:10px 14px}
.clock-label{font-size:11px;color:var(--text-label);font-weight:600;margin-bottom:2px}
.clock-time{font-size:22px;font-weight:800;color:var(--text-primary);font-variant-numeric:tabular-nums;letter-spacing:1px}

/* Day Tabs */
.day-tabs{display:flex;gap:6px;margin-bottom:14px;overflow-x:auto;padding-bottom:4px;-webkit-overflow-scrolling:touch;scroll-snap-type:x proximity}
.day-tab{flex:0 0 auto;padding:8px 14px;border-radius:12px;cursor:pointer;text-align:center;font-size:12px;font-weight:700;transition:all .2s;touch-action:manipulation;scroll-snap-align:start;border:1px solid var(--tab-border);background:var(--tab-bg);color:var(--tab-text)}
.day-tab.active{border:none;background:linear-gradient(135deg,var(--btn-gradient-1),var(--btn-gradient-2));color:#fff;box-shadow:0 4px 12px var(--btn-shadow)}
.day-tab[role="tab"]{outline:none}
.day-tab[role="tab"]:focus-visible{outline:2px solid var(--btn-gradient-2);outline-offset:2px}
.day-tab-num{font-weight:700}
.day-tab-date{font-size:10px;opacity:.85;margin-top:1px}

/* Day Header */
.day-header{padding:12px 16px;margin-bottom:14px;display:flex;justify-content:space-between;align-items:center}
.day-title{font-size:16px;font-weight:800;color:var(--text-primary)}
.day-sub{font-size:11px;color:var(--text-secondary)}
.day-cost{text-align:right}
.day-yen{font-size:14px;font-weight:700;color:var(--text-primary)}
.day-krw{font-size:10px;color:var(--text-secondary)}

/* Outfit */
.outfit-title{font-size:13px;font-weight:700;color:var(--text-accent);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.couple-badge{font-size:10px;background:var(--couple-badge-bg);color:var(--couple-badge-text);padding:2px 8px;border-radius:8px;font-weight:600}
.outfit-grid{display:flex;gap:8px;margin-bottom:14px}
.outfit-person{flex:1;text-align:center;padding:12px 10px}
.outfit-name{font-size:12px;font-weight:800;color:var(--text-link);margin-bottom:10px}
.outfit-items{display:flex;gap:6px}
.outfit-item{flex:1;border-radius:12px;padding:10px 6px}
.outfit-item.top{background:linear-gradient(135deg,var(--outfit-top-bg1),var(--outfit-top-bg2))}
.outfit-item.bottom{background:linear-gradient(135deg,var(--outfit-bottom-bg1),var(--outfit-bottom-bg2))}
.outfit-emoji{font-size:24px;margin-bottom:4px}
.outfit-label{font-size:9px;font-weight:600;margin-bottom:2px}
.outfit-item.top .outfit-label{color:var(--outfit-top-label)}
.outfit-item.bottom .outfit-label{color:var(--outfit-bottom-label)}
.outfit-text{font-size:10px;font-weight:700;line-height:1.3}
.outfit-item.top .outfit-text{color:var(--outfit-top-text)}
.outfit-item.bottom .outfit-text{color:var(--outfit-bottom-text)}

/* TODO */
.todo-title{font-size:13px;font-weight:700;color:var(--text-accent);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.todo-item{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;margin-bottom:6px;transition:all .2s}
.todo-item.unchecked{background:var(--todo-unchecked-bg);border:1px solid var(--todo-unchecked-border)}
.todo-item.checked{background:var(--todo-checked-bg);border:1px solid var(--todo-checked-border);opacity:.65}
.checkbox{width:24px;height:24px;border-radius:8px;flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;touch-action:manipulation}
.checkbox[role="checkbox"]{outline:none}
.checkbox[role="checkbox"]:focus-visible{outline:2px solid var(--btn-gradient-2);outline-offset:2px}
.checkbox.off{border:2px solid var(--checkbox-border);background:var(--checkbox-bg)}
.checkbox.on{border:none;background:linear-gradient(135deg,var(--btn-gradient-1),var(--btn-gradient-2))}
.checkbox.on::after{content:'âœ“';color:#fff;font-size:14px;font-weight:800}
.todo-time{width:44px;font-size:12px;font-weight:700;color:var(--text-link);font-variant-numeric:tabular-nums;flex-shrink:0}
.todo-info{flex:1;min-width:0}
.todo-activity{font-size:12px;font-weight:700;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.todo-location{font-size:10px;color:var(--text-secondary);margin-top:1px}
.checked .todo-time,.checked .todo-activity{text-decoration:line-through;color:var(--text-muted)}
.todo-cost{text-align:right;flex-shrink:0;display:flex;align-items:center;gap:4px}
.cost-yen{font-size:12px;font-weight:700;color:var(--text-primary)}
.cost-yen.est{color:var(--color-est)}
.cost-est{font-size:8px;margin-left:2px}
.cost-free{font-size:10px;color:var(--color-free);font-weight:600}
.cost-diff{font-size:9px;font-weight:700;margin-top:1px}
.cost-diff.over{color:var(--color-over)}
.cost-diff.under{color:var(--color-under)}
.btn-quick-spend{background:var(--btn-sec-bg);border:1px solid var(--btn-sec-border);border-radius:6px;padding:3px 6px;font-size:9px;font-weight:600;color:var(--text-link);cursor:pointer;touch-action:manipulation;white-space:nowrap;flex-shrink:0}
.btn-quick-spend:active{transform:scale(.92)}

/* Budget Screen */
.budget-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.budget-title{font-size:20px;font-weight:800;color:var(--text-primary)}
.budget-actions{display:flex;gap:6px;align-items:center}
.rate-bar{padding:14px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between}
.rate-icon{font-size:20px}
.rate-val{font-size:14px;font-weight:700;color:var(--text-primary)}
.rate-time{font-size:10px;color:var(--text-secondary)}
.summary-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px}
.summary-card{border-radius:14px;padding:12px 8px;text-align:center;transition:background .3s}
.summary-label{font-size:10px;font-weight:600;margin-bottom:4px}
.summary-val{font-size:14px;font-weight:800}
.summary-sub{font-size:10px;opacity:.7;margin-top:2px}
.summary-edit{font-size:8px;color:var(--text-muted);margin-top:2px}
.progress-wrap{padding:10px 14px;margin-bottom:14px}
.progress-top{display:flex;justify-content:space-between;margin-bottom:6px}
.progress-label{font-size:10px;color:var(--text-secondary);font-weight:600}
.progress-pct{font-size:10px;font-weight:700}
.progress-bar{height:8px;background:var(--progress-track);border-radius:4px;overflow:hidden}
.progress-fill{height:100%;border-radius:4px;transition:width .5s ease}
.progress-note{font-size:9px;color:var(--text-muted);margin-top:4px;text-align:center}
.input-section{padding:16px;margin-bottom:16px}
.input-title{font-size:14px;font-weight:700;color:var(--text-primary);margin-bottom:12px}
.input-row{display:flex;gap:6px;margin-bottom:4px;flex-wrap:wrap}
.input-row-top{display:flex;gap:6px;width:100%;margin-bottom:6px}
.input-row-bottom{display:flex;gap:6px;width:100%}
.input-select{width:72px;padding:10px 4px;border-radius:10px;border:1px solid var(--input-border);font-size:12px;outline:none;background:var(--input-bg);color:var(--text-link);font-weight:600;transition:background .3s,border-color .3s}
.input-text{flex:1;padding:10px 12px;border-radius:10px;border:1px solid var(--input-border);font-size:13px;outline:none;background:var(--input-bg);color:var(--text-primary);transition:background .3s,border-color .3s}
.input-number{flex:1;padding:10px 12px;border-radius:10px;border:1px solid var(--input-border);font-size:13px;outline:none;background:var(--input-bg);color:var(--text-primary);transition:background .3s,border-color .3s}
.input-hint{font-size:10px;color:var(--text-muted);text-align:center;margin-top:4px}
.btn-add{background:linear-gradient(135deg,var(--btn-gradient-1),var(--btn-gradient-2));color:#fff;border:none;border-radius:10px;padding:10px 14px;font-size:14px;font-weight:700;cursor:pointer;flex-shrink:0;touch-action:manipulation}
.day-budget{padding:12px 14px;margin-bottom:8px}
.day-budget-top{display:flex;justify-content:space-between;align-items:center}
.day-budget-label{font-size:12px;font-weight:700;color:var(--text-link)}
.day-budget-title{font-size:11px;color:var(--text-secondary);margin-left:6px}
.day-budget-planned{font-size:11px;color:var(--text-secondary)}
.day-budget-actual{font-size:12px;font-weight:700;color:var(--text-primary)}
.day-budget-diff{font-size:10px;font-weight:700}
.spending-item{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-top:1px solid var(--spending-border);font-size:12px}
.spending-name{color:var(--text-accent);flex:1}
.spending-cost{font-weight:600;color:var(--text-primary);font-variant-numeric:tabular-nums}
.spending-krw{font-size:10px;color:var(--text-secondary);margin-left:6px}
.btn-delete{border:none;border-radius:6px;padding:2px 6px;font-size:10px;cursor:pointer;font-weight:600;margin-left:6px;transition:all .15s;touch-action:manipulation}
.btn-delete.normal{background:var(--del-normal-bg);color:var(--del-normal-text)}
.btn-delete.confirm{background:var(--del-confirm-bg);color:#fff}
.fixed-expense-card{background:var(--card-special-bg);border-radius:14px;padding:12px 16px;margin-top:4px;border:1px solid var(--card-special-border);display:flex;justify-content:space-between;align-items:center;transition:background .3s,border-color .3s}
.fixed-expense-label{font-size:13px;font-weight:700;color:var(--color-under)}
.fixed-expense-sub{font-size:10px;color:var(--text-secondary)}
.budget-edit-input{width:100%;font-size:13px;font-weight:700;text-align:center;border:1px solid var(--checkbox-border);border-radius:8px;padding:4px;outline:none;background:var(--input-bg);color:var(--text-primary)}
.btn-confirm-budget{margin-top:4px;font-size:10px;background:var(--btn-gradient-2);color:#fff;border:none;border-radius:6px;padding:3px 10px;cursor:pointer;font-weight:600}

/* Backup/Restore section */
.backup-section{padding:14px;margin-bottom:12px;text-align:center}
.backup-title{font-size:12px;font-weight:700;color:var(--text-primary);margin-bottom:10px}
.backup-btns{display:flex;gap:8px;justify-content:center}
.backup-btns .btn-secondary{font-size:11px}
#fileRestore{display:none}

/* Quick Spend Modal */
.modal-overlay{position:fixed;inset:0;z-index:100;background:rgba(0,0,0,.45);display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s}
.modal-overlay.active{opacity:1;pointer-events:auto}
.modal-content{width:100%;max-width:500px;background:var(--glass-bg);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-radius:20px 20px 0 0;padding:24px 20px calc(env(safe-area-inset-bottom,20px) + 20px);transform:translateY(100%);transition:transform .3s ease}
.modal-overlay.active .modal-content{transform:translateY(0)}
.modal-title{font-size:15px;font-weight:800;color:var(--text-primary);margin-bottom:4px}
.modal-sub{font-size:11px;color:var(--text-secondary);margin-bottom:14px}
.modal-input-row{display:flex;gap:8px;margin-bottom:10px}
.modal-input{flex:1;padding:12px;border-radius:12px;border:1px solid var(--input-border);font-size:14px;outline:none;background:var(--input-bg);color:var(--text-primary)}
.modal-btns{display:flex;gap:8px}
.modal-btns .btn-primary{flex:1;padding:12px;font-size:14px}
.modal-btns .btn-secondary{flex:1;padding:12px;text-align:center}

/* Toast */
.toast-container{position:fixed;top:max(env(safe-area-inset-top,16px),16px);left:50%;transform:translateX(-50%);z-index:200;display:flex;flex-direction:column;gap:8px;pointer-events:none;max-width:400px;width:calc(100% - 32px)}
.toast{pointer-events:auto;background:var(--toast-bg);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-radius:12px;padding:10px 16px;font-size:12px;font-weight:600;color:var(--text-primary);box-shadow:0 4px 20px var(--toast-shadow);display:flex;align-items:center;gap:8px;opacity:0;transform:translateY(-12px);animation:toastIn .3s ease forwards}
.toast.out{animation:toastOut .25s ease forwards}
@keyframes toastIn{to{opacity:1;transform:translateY(0)}}
@keyframes toastOut{to{opacity:0;transform:translateY(-12px)}}
.toast-icon{font-size:16px;flex-shrink:0}
.toast-msg{flex:1}

/* Animations */
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.fade-in{animation:fadeIn .3s ease}

/* Install Banner */
.install-banner{position:fixed;bottom:0;left:0;right:0;z-index:999;padding:16px;padding-bottom:calc(env(safe-area-inset-bottom,16px) + 16px);background:var(--toast-bg);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--glass-border);display:flex;align-items:center;justify-content:space-between;gap:12px}
.install-text{font-size:12px;color:var(--text-primary);font-weight:600}
.install-sub{font-size:10px;color:var(--text-secondary);margin-top:2px}
.btn-install{background:linear-gradient(135deg,var(--btn-gradient-1),var(--btn-gradient-2));color:#fff;border:none;border-radius:10px;padding:10px 16px;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap}
.btn-dismiss{background:none;border:none;color:var(--text-secondary);font-size:11px;cursor:pointer;padding:4px 8px}
.hidden{display:none!important}

/* Swipe Animation */
.day-content{position:relative;overflow:hidden}
.day-content-inner{transition:none;will-change:transform}
.day-content-inner.snapping{transition:transform .3s cubic-bezier(.25,.46,.45,.94),opacity .3s ease}
.swipe-preview{position:fixed;top:50%;z-index:50;transform:translateY(-50%);pointer-events:none;opacity:0;transition:opacity .15s}
.swipe-preview.visible{opacity:1}
.swipe-preview-bubble{background:var(--glass-bg);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid var(--glass-border);border-radius:14px;padding:10px 16px;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,.12)}
.swipe-preview-day{font-size:13px;font-weight:800;color:var(--text-primary)}
.swipe-preview-title{font-size:10px;color:var(--text-secondary);margin-top:2px}
.swipe-preview.left{left:12px}
.swipe-preview.right{right:12px}
.swipe-overlay{position:fixed;inset:0;pointer-events:none;z-index:49;opacity:0;transition:opacity .15s}
.swipe-overlay.dragging{opacity:1;background:linear-gradient(90deg,rgba(0,0,0,.04) 0%,transparent 15%,transparent 85%,rgba(0,0,0,.04) 100%)}
</style>
</head>
<body>
<div class="snow-wrap" id="snowWrap"></div>
<div class="app" id="app"></div>
<div class="toast-container" id="toastContainer"></div>

<!-- Swipe Preview Bubbles -->
<div class="swipe-preview left" id="swipePreviewLeft">
  <div class="swipe-preview-bubble">
    <div class="swipe-preview-day" id="spLeftDay"></div>
    <div class="swipe-preview-title" id="spLeftTitle"></div>
  </div>
</div>
<div class="swipe-preview right" id="swipePreviewRight">
  <div class="swipe-preview-bubble">
    <div class="swipe-preview-day" id="spRightDay"></div>
    <div class="swipe-preview-title" id="spRightTitle"></div>
  </div>
</div>
<div class="swipe-overlay" id="swipeOverlay"></div>

<!-- Quick Spend Modal -->
<div class="modal-overlay" id="quickModal">
  <div class="modal-content">
    <div class="modal-title" id="qmTitle">ğŸ’¸ ì‹¤ì œ ê¸ˆì•¡ ì…ë ¥</div>
    <div class="modal-sub" id="qmSub"></div>
    <div class="modal-input-row">
      <input class="modal-input" id="qmInput" type="number" placeholder="Â¥ ì‹¤ì œ ê¸ˆì•¡">
    </div>
    <div class="modal-btns">
      <button class="btn-primary" onclick="submitQuickSpend()">ì €ì¥</button>
      <button class="btn-secondary" onclick="closeQuickSpend()">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<input type="file" id="fileRestore" accept=".json" onchange="handleRestore(event)">

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG â€” ì¬ì‚¬ìš© ì‹œ ì—¬ê¸°ë§Œ ìˆ˜ì • (A-1, A-2)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CONFIG = {
  travelers: ["ì¤€ì˜", "ì •ì›"],
  tripTitle: "í™‹ì¹´ì´ë„ ì—¬í–‰",
  tripEmoji: "â„ï¸",
  tripPeriod: "2026.02.24 â€” 02.28",
  tripDuration: "4ë°• 5ì¼",
  currency: { from: "JPY", to: "KRW", symbol: "Â¥", toSymbol: "â‚©" },
  rateApi: "https://open.er-api.com/v6/latest/JPY",
  defaultRate: 9.36,
  defaultBudget: 170000,
  storagePrefix: "hk",
  timezones: [
    { label: "ğŸ‡°ğŸ‡· ëŒ€í•œë¯¼êµ­", tz: "Asia/Seoul" },
    { label: "ğŸ‡¯ğŸ‡µ ì‚¿í¬ë¡œ", tz: "Asia/Tokyo" }
  ],
  fixedExpenses: [
    { name: "ì˜¤íƒ€ë£¨ í›„ë£¨ì¹´ì™€", emoji: "ğŸ¯", cost: 41000, desc: "ìˆ™ë°•ë¹„ (ì „ì„¸íƒ• ë³„ë„ Â¥2,500/íšŒ)" }
  ]
};

const OUTFITS = [
  {day:1,[CONFIG.travelers[0]]:{top:"ì²­ë¡ìƒ‰ ë‹ˆíŠ¸",bottom:"ê²€ì • ë°”ì§€",te:"ğŸ§¶",be:"ğŸ‘–"},[CONFIG.travelers[1]]:{top:"ë‹ˆíŠ¸",bottom:"íšŒìƒ‰ ë°”ì§€",te:"ğŸ§¶",be:"ğŸ‘–"}},
  {day:2,[CONFIG.travelers[0]]:{top:"ì…”ì¸  + ë…¸ë€ ìŠ¤ì›¨í„°",bottom:"ì²­ë°”ì§€",te:"ğŸ‘”",be:"ğŸ‘–"},[CONFIG.travelers[1]]:{top:"ë…¸ë€ ìŠ¤ì›¨í„°",bottom:"ì²­ì¹˜ë§ˆ",te:"ğŸ§¶",be:"ğŸ‘—"}},
  {day:3,[CONFIG.travelers[0]]:{top:"ì…”ì¸  + ê²€ì •ì¡°ë¼",bottom:"ê²€ì • ë°”ì§€",te:"ğŸ¦º",be:"ğŸ‘–"},[CONFIG.travelers[1]]:{top:"ê²€ì • ì˜¤í”„ìˆ„ë”",bottom:"ì²´í¬ë¬´ëŠ¬ ë¡±ì¹˜ë§ˆ",te:"ğŸ‘š",be:"ğŸ‘—"}},
  {day:4,[CONFIG.travelers[0]]:{top:"í•˜ëŠ˜ìƒ‰ ìŠ¤ì›¨í„°",bottom:"í° ë°”ì§€",te:"ğŸ§¶",be:"ğŸ‘–"},[CONFIG.travelers[1]]:{top:"í•˜ëŠ˜ìƒ‰ ìŠ¤ì›¨í„°",bottom:"í° ë°”ì§€",te:"ğŸ§¶",be:"ğŸ‘–"}},
  {day:5,[CONFIG.travelers[0]]:{top:"íšŒìƒ‰ ì²´í¬ ë§¨íˆ¬ë§¨",bottom:"í° ë°”ì§€",te:"ğŸ‘•",be:"ğŸ‘–"},[CONFIG.travelers[1]]:{top:"ë‹ˆíŠ¸",bottom:"íšŒìƒ‰ ë°”ì§€",te:"ğŸ§¶",be:"ğŸ‘–"}}
];

const DAYS = [
  {day:1,date:"2/24",wd:"í™”",title:"ì¸ì²œ â†’ ë…¸ë³´ë¦¬ë² ì“°",events:[
    {t:"10:00",a:"ê³µí•­ ë„ì°©",l:"ì¸ì²œê³µí•­",c:0,i:"âœˆï¸"},
    {t:"11:00",a:"ê³µí•­ë°¥",l:"ì¸ì²œê³µí•­",c:1500,i:"ğŸ±",e:1},
    {t:"12:55",a:"ì¶œë°œ",l:"ì¸ì²œ â†’ ì‹ ì¹˜í† ì„¸",c:0,i:"âœˆï¸"},
    {t:"15:40",a:"ì‹ ì¹˜í† ì„¸ ë„ì°©",l:"ì‹ ì¹˜í† ì„¸ ê³µí•­",c:0,i:"ğŸ›¬"},
    {t:"16:30",a:"ê³µí•­â†’ë…¸ë³´ë¦¬ë² ì“°",l:"JR íŠ¹ê¸‰ì—´ì°¨",c:6300,i:"ğŸšƒ"},
    {t:"19:30",a:"ìˆ™ì†Œ ë„ì°©",l:"ë‹¤ì´ì´ì¹˜ ë‹¤í‚¤ëª¨í† ì¹¸",c:30305,i:"ğŸ¨"},
    {t:"20:00",a:"í¸ì˜ì  ì €ë…",l:"í¸ì˜ì ",c:1500,i:"ğŸœ",e:1},
    {t:"21:00",a:"ë°¤ ì§€ì˜¥ê³„ê³¡ ì‚°ì±…",l:"ì§€ì˜¥ê³„ê³¡",c:0,i:"ğŸŒ‹"},
    {t:"22:00",a:"ëŒ€ìš•íƒ• ì˜¨ì²œ",l:"ë‹¤í‚¤ëª¨í† ì¹¸",c:0,i:"â™¨ï¸"}
  ]},
  {day:2,date:"2/25",wd:"ìˆ˜",title:"ë…¸ë³´ë¦¬ë² ì“° â†’ ì‚¿í¬ë¡œ",events:[
    {t:"08:00",a:"ê¸°ìƒ + ì§€ì˜¥ê³„ê³¡",l:"ì§€ì˜¥ê³„ê³¡",c:0,i:"ğŸŒ„"},
    {t:"09:00",a:"ëŒ€ìš•íƒ• ì˜¨ì²œ",l:"ë‹¤í‚¤ëª¨í† ì¹¸",c:0,i:"â™¨ï¸"},
    {t:"10:00",a:"ë§ˆë¦°íŒŒí¬ ë‹‰ìŠ¤",l:"ë…¸ë³´ë¦¬ë² ì“°",c:5600,i:"ğŸ§"},
    {t:"11:00",a:"í­ê·„ì›Œí¬ + ê¸°ì°¨ë°¥",l:"ë§ˆë¦°íŒŒí¬/ì—­",c:1000,i:"ğŸ™",e:1},
    {t:"12:00",a:"ì‚¿í¬ë¡œ ì´ë™",l:"JR íŠ¹ê¸‰ì—´ì°¨",c:3800,i:"ğŸšƒ"},
    {t:"14:30",a:"í˜¸í…” ì²´í¬ì¸",l:"ê²Œì´ì˜¤ í”Œë¼ì",c:42522,i:"ğŸ¨"},
    {t:"15:00",a:"ìˆ˜í”„ì¹´ë ˆí‚¹+ë§¥ì£¼",l:"ìˆ˜í”„ì¹´ë ˆí‚¹",c:4200,i:"ğŸ›"},
    {t:"15:30",a:"ë§ˆì§€ì‚°ë„",l:"ì‚¿í¬ë¡œ ì‹œë‚´",c:1300,i:"ğŸ"},
    {t:"16:00",a:"ë§¥ì£¼ê³µì¥ ê²¬í•™",l:"ì‚¿í¬ë¡œ ë§¥ì£¼ ë°•ë¬¼ê´€",c:1000,i:"ğŸº",e:1},
    {t:"17:00",a:"ì§•ê¸°ìŠ¤ì¹¸ ë§ˆì‚¬ì§„",l:"ìŠ¤ìŠ¤í‚¤ë…¸ ë³¸ì ",c:4200,i:"ğŸ¥©"},
    {t:"19:00",a:"í¸ì˜ì Â·ì•¼ì‹œì¥",l:"ì‚¿í¬ë¡œ ì‹œë‚´",c:1500,i:"ğŸª",e:1}
  ]},
  {day:3,date:"2/26",wd:"ëª©",title:"ì‚¿í¬ë¡œ ì‹œë‚´ ê´€ê´‘",events:[
    {t:"10:00",a:"ê¸°ìƒ",l:"ê²Œì´ì˜¤ í”Œë¼ì",c:0,i:"ğŸ˜´"},
    {t:"11:30",a:"í•´ë¬¼ë®ë°¥",l:"í•´ë¬¼ ë®ë°¥ ì „ë¬¸ì ",c:2500,i:"ğŸ£",e:1},
    {t:"14:30",a:"ë¯¸ì†Œ ë¼ë©˜",l:"ë¼ë©˜ ìš”ì½”ì´ˆ",c:1000,i:"ğŸœ",e:1},
    {t:"15:00",a:"ë‹ˆì¹´ìƒ í¬í† ì¡´",l:"ìŠ¤ìŠ¤í‚¤ë…¸",c:0,i:"ğŸ“¸"},
    {t:"19:00",a:"ì„±ê²Œ ìš”ë¦¬",l:"ìš°ë¯¸ì‚¬ì¿ ë¼",c:9000,i:"ğŸ¦”"},
    {t:"21:00",a:"ì•¼í‚¤ë‹ˆì¿ ",l:"ì¿ ì´í…Œì´/ì‹œë¶€í‚¤",c:12000,i:"ğŸ¥©"},
    {t:"22:30",a:"ëŒ€ê´€ëŒì°¨",l:"ë…¸ë¥´ë² ì‚¬",c:2000,i:"ğŸ¡"},
    {t:"23:00",a:"í¸ì˜ì  í„¸ì´",l:"í¸ì˜ì ",c:1000,i:"ğŸª",e:1}
  ]},
  {day:4,date:"2/27",wd:"ê¸ˆ",title:"ì‚¿í¬ë¡œ â†’ ì˜¤íƒ€ë£¨",events:[
    {t:"10:00",a:"ê¸°ìƒ",l:"ê²Œì´ì˜¤ í”Œë¼ì",c:0,i:"ğŸ˜´"},
    {t:"11:00",a:"ì²´í¬ì•„ì›ƒâ†’ì˜¤íƒ€ë£¨",l:"JR ì¾Œì†",c:3400,i:"ğŸšƒ"},
    {t:"14:00",a:"ì ì‹¬ ì´ˆë°¥",l:"í–¥í† ìš”ë¦¬ ì˜¤ì˜¤í† ë¯¸",c:4000,i:"ğŸ£"},
    {t:"14:30",a:"ì˜¤ë¥´ê³¨ë‹¹ ë³¸ê´€",l:"ì˜¤ë¥´ê³¨ë‹¹",c:0,i:"ğŸµ"},
    {t:"15:00",a:"ì˜¤íƒ€ë£¨ ììœ ì‹œê°„",l:"ì˜¤íƒ€ë£¨ ì‹œë‚´",c:0,i:"ğŸš¶"},
    {t:"16:00",a:"ì „ì„¸íƒ•",l:"ì˜¤íƒ€ë£¨ í›„ë£¨ì¹´ì™€",c:2500,i:"â™¨ï¸"},
    {t:"18:00",a:"ì €ë… ê°€ì´ì„¸í‚¤",l:"ì˜¤íƒ€ë£¨ í›„ë£¨ì¹´ì™€",c:8000,i:"ğŸ½ï¸"},
    {t:"19:00",a:"ì˜¤íƒ€ë£¨ ìš´í•˜ ì•¼ê²½",l:"ì˜¤íƒ€ë£¨ ìš´í•˜",c:0,i:"ğŸŒƒ"}
  ]},
  {day:5,date:"2/28",wd:"í† ",title:"ì˜¤íƒ€ë£¨ â†’ ì¸ì²œ",events:[
    {t:"07:00",a:"ê¸°ìƒ + ì „ì„¸íƒ•",l:"ì˜¤íƒ€ë£¨ í›„ë£¨ì¹´ì™€",c:2500,i:"â™¨ï¸"},
    {t:"09:00",a:"ì•„ì¹¨ ê°€ì´ì„¸í‚¤",l:"ì˜¤íƒ€ë£¨ í›„ë£¨ì¹´ì™€",c:8000,i:"ğŸ½ï¸"},
    {t:"10:30",a:"ì²´í¬ì•„ì›ƒâ†’ê³µí•­",l:"JR (1ì‹œê°„30ë¶„)",c:0,i:"ğŸšƒ"},
    {t:"12:30",a:"ê³µí•­ ë©´ì„¸+ë°¥",l:"ì‹ ì¹˜í† ì„¸ ê³µí•­",c:2000,i:"ğŸ›ï¸",e:1},
    {t:"14:00",a:"ë¹„í–‰ê¸° (ë¨€ë¨€ë¯¸)",l:"ì‹ ì¹˜í† ì„¸â†’ì¸ì²œ",c:0,i:"âœˆï¸"},
    {t:"14:40",a:"ë¹„í–‰ê¸° (ë¼ì§€)",l:"ì‹ ì¹˜í† ì„¸â†’ì¸ì²œ",c:0,i:"âœˆï¸"},
    {t:"17:15",a:"ë„ì°© (ë¨€ë¨€ë¯¸)",l:"ì¸ì²œê³µí•­",c:0,i:"ğŸ›¬"},
    {t:"18:10",a:"ë„ì°© (ë¼ì§€)",l:"ì¸ì²œê³µí•­",c:0,i:"ğŸ›¬"}
  ]}
];

const FIXED_TOTAL = CONFIG.fixedExpenses.reduce((s, x) => s + x.cost, 0);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SK = CONFIG.storagePrefix;
const load = (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d } catch { return d } };
const save = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)) } catch {} };
const fmt = n => n.toLocaleString("ko-KR");

let state = {
  activeDay: 0,
  showBudget: false,
  checked: load(`${SK}-c`, {}),
  rate: load(`${SK}-r`, CONFIG.defaultRate),
  rateTime: load(`${SK}-rt`, "ê¸°ë³¸ê°’ ì‚¬ìš© ì¤‘"),
  rateLoading: false,
  spending: load(`${SK}-s`, []),
  budget: load(`${SK}-b`, CONFIG.defaultBudget),
  editingBudget: false,
  budgetInput: "",
  confirmDelete: null,
  confirmDeleteTimer: null, // C-1: auto-reset timer
  inputDay: 1,
  inputName: "",
  inputCost: "",
  darkMode: load(`${SK}-dm`, false),
  quickSpend: null // {dayIdx, eventIdx, eventName, plannedCost}
};

// Apply saved theme immediately
if (state.darkMode) {
  document.documentElement.setAttribute('data-theme', 'dark');
  document.querySelector('meta[name="theme-color"]')?.setAttribute('content', '#0F1923');
}

let _renderQueued = false;
function setState(patch) {
  Object.assign(state, patch);
  if (!_renderQueued) {
    _renderQueued = true;
    requestAnimationFrame(() => { _renderQueued = false; render(); });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg, icon = "â„¹ï¸", duration = 2500) {
  const container = document.getElementById("toastContainer");
  const toast = document.createElement("div");
  toast.className = "toast";
  const iconSpan = document.createElement("span");
  iconSpan.className = "toast-icon";
  iconSpan.textContent = icon;
  const msgSpan = document.createElement("span");
  msgSpan.className = "toast-msg";
  msgSpan.textContent = msg;
  toast.appendChild(iconSpan);
  toast.appendChild(msgSpan);
  container.appendChild(toast);
  setTimeout(() => {
    toast.classList.add("out");
    toast.addEventListener("animationend", () => toast.remove());
  }, duration);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SNOWFLAKES (B-6: single style block)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initSnow() {
  const w = document.getElementById("snowWrap");
  let keyframes = "";
  window._snowRandom = [];
  for (let i = 0; i < 18; i++) {
    const f = document.createElement("div");
    f.className = "snowflake";
    const s = 2 + Math.random() * 5;
    const d = 7 + Math.random() * 8;
    const dl = Math.random() * 10;
    const l = Math.random() * 100;
    const rnd = Math.random() * 0.2;
    window._snowRandom.push(rnd);
    const baseOp = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--snow-opacity-base'));
    const dr = (Math.random() - .5) * 30;
    f.style.cssText = `left:${l}%;width:${s}px;height:${s}px;opacity:${baseOp + rnd};animation:sf${i} ${d}s linear ${dl}s infinite`;
    w.appendChild(f);
    keyframes += `@keyframes sf${i}{0%{transform:translateY(-10px)translateX(0)}50%{transform:translateY(50vh)translateX(${dr}px)}100%{transform:translateY(105vh)translateX(0)}}`;
  }
  const style = document.createElement("style");
  style.textContent = keyframes;
  document.head.appendChild(style);
}

function updateSnowOpacity() {
  const flakes = document.querySelectorAll(".snowflake");
  const baseOp = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--snow-opacity-base'));
  flakes.forEach((f, i) => {
    const rnd = (window._snowRandom && window._snowRandom[i]) || 0;
    f.style.opacity = baseOp + rnd;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateClocks() {
  const n = new Date();
  const o = { hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false };
  CONFIG.timezones.forEach((tz, i) => {
    const el = document.getElementById(`clk${i}`);
    if (el) el.textContent = n.toLocaleTimeString("ko-KR", { timeZone: tz.tz, ...o });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RATE (C-3: error feedback)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function refreshRate() {
  setState({ rateLoading: true });
  try {
    const r = await fetch(CONFIG.rateApi);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const d = await r.json();
    if (d.rates?.KRW) {
      const nr = d.rates.KRW;
      const t = new Date().toLocaleString("ko-KR") + " ê¸°ì¤€";
      save(`${SK}-r`, nr); save(`${SK}-rt`, t);
      setState({ rate: nr, rateTime: t, rateLoading: false });
      showToast(`í™˜ìœ¨ ì—…ë°ì´íŠ¸: 1${CONFIG.currency.symbol} = ${CONFIG.currency.toSymbol}${nr.toFixed(2)}`, "ğŸ’±");
      return;
    }
    throw new Error("No KRW rate");
  } catch (e) {
    console.error(e);
    setState({ rateLoading: false });
    showToast("í™˜ìœ¨ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.", "âš ï¸", 3500);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DARK MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleDarkMode() {
  const dm = !state.darkMode;
  document.documentElement.setAttribute('data-theme', dm ? 'dark' : 'light');
  // C-4: Update theme-color meta tag
  document.querySelector('meta[name="theme-color"]')?.setAttribute('content', dm ? '#0F1923' : '#DFF0FB');
  save(`${SK}-dm`, dm);
  state.darkMode = dm;
  showToast(dm ? "ë‹¤í¬ ëª¨ë“œ ì¼œì§" : "ë¼ì´íŠ¸ ëª¨ë“œ ì¼œì§", dm ? "ğŸŒ™" : "â˜€ï¸");
  // B-3: Update snowflake opacity for new theme
  updateSnowOpacity();
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleCheck(di, ei) {
  const k = `${di}-${ei}`;
  state.checked[k] = !state.checked[k];
  save(`${SK}-c`, state.checked);
  render();
}

function addSpending() {
  const n = state.inputName.trim(), c = Number(state.inputCost);
  if (!n || !c || c <= 0) {
    if (!n && !c) showToast("í•­ëª©ëª…ê³¼ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "âš ï¸");
    else if (!n) showToast("í•­ëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "âš ï¸");
    else showToast("ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "âš ï¸");
    return;
  }
  const item = { id: crypto.randomUUID ? crypto.randomUUID() : `${Date.now()}-${Math.random().toString(36).slice(2,8)}`, name: n, cost: c, day: state.inputDay };
  state.spending.push(item);
  save(`${SK}-s`, state.spending);
  setState({ inputName: "", inputCost: "" });
  showToast(`Day ${state.inputDay}ì— ${CONFIG.currency.symbol}${fmt(c)} ì¶”ê°€ë¨`, "âœ…");
}

// C-1: confirmDelete with auto-reset
function removeSpending(id) {
  if (state.confirmDelete !== id) {
    if (state.confirmDeleteTimer) clearTimeout(state.confirmDeleteTimer);
    const timer = setTimeout(() => {
      if (state.confirmDelete === id) setState({ confirmDelete: null, confirmDeleteTimer: null });
    }, 3000);
    setState({ confirmDelete: id, confirmDeleteTimer: timer });
    return;
  }
  if (state.confirmDeleteTimer) clearTimeout(state.confirmDeleteTimer);
  const item = state.spending.find(x => x.id === id);
  state.spending = state.spending.filter(x => x.id !== id);
  save(`${SK}-s`, state.spending);
  setState({ confirmDelete: null, confirmDeleteTimer: null });
  if (item) showToast(`"${item.name}" ì‚­ì œë¨`, "ğŸ—‘ï¸");
}

function saveBudget() {
  if (!state.editingBudget) return;
  const v = Number(state.budgetInput);
  if (v > 0) { state.budget = v; save(`${SK}-b`, v); showToast(`ì˜ˆì‚°ì´ ${CONFIG.currency.symbol}${fmt(v)}ìœ¼ë¡œ ë³€ê²½ë¨`, "âœ…"); }
  setState({ editingBudget: false });
}

function cancelBudgetEdit() {
  setState({ editingBudget: false, budgetInput: "" });
}

function spendByDay(dn) { return state.spending.filter(x => x.day === dn).reduce((s, x) => s + x.cost, 0); }

// C-1 fix: sum ALL matching spending items (filter+reduce instead of find)
function getActual(di, ei) {
  const ev = DAYS[di].events[ei];
  if (ev.c === 0) return null;
  const normalize = s => s.replace(/\s+/g, '').toLowerCase();
  const target = normalize(ev.a);
  const matches = state.spending.filter(x => {
    if (x.day !== DAYS[di].day) return false;
    const n = normalize(x.name);
    return n === target || target.includes(n) || n.includes(target);
  });
  if (matches.length === 0) return null;
  return matches.reduce((sum, x) => sum + x.cost, 0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUICK SPEND (Feature 2)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openQuickSpend(di, ei, ev) {
  ev.stopPropagation();
  const event = DAYS[di].events[ei];
  state.quickSpend = { dayIdx: di, eventIdx: ei, eventName: event.a, plannedCost: event.c, dayNum: DAYS[di].day };
  const modal = document.getElementById("quickModal");
  const title = document.getElementById("qmTitle");
  const sub = document.getElementById("qmSub");
  const input = document.getElementById("qmInput");
  title.textContent = `ğŸ’¸ ${event.a}`;
  sub.textContent = `Day ${DAYS[di].day} Â· ê³„íš ${CONFIG.currency.symbol}${fmt(event.c)}`;
  input.value = "";
  modal.classList.add("active");
  document.body.style.overflow = "hidden";
  setTimeout(() => input.focus(), 300);
}

function closeQuickSpend() {
  document.getElementById("quickModal").classList.remove("active");
  document.body.style.overflow = "";
  state.quickSpend = null;
}

function submitQuickSpend() {
  const input = document.getElementById("qmInput");
  const cost = Number(input.value);
  if (!cost || cost <= 0) { showToast("ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "âš ï¸"); return; }
  const qs = state.quickSpend;
  if (!qs) return;
  // Remove existing entry for this event if any
  const normalize = s => s.replace(/\s+/g, '').toLowerCase();
  state.spending = state.spending.filter(x => !(x.day === qs.dayNum && normalize(x.name) === normalize(qs.eventName)));
  const item = { id: crypto.randomUUID ? crypto.randomUUID() : `${Date.now()}-${Math.random().toString(36).slice(2,8)}`, name: qs.eventName, cost, day: qs.dayNum };
  state.spending.push(item);
  save(`${SK}-s`, state.spending);
  closeQuickSpend();
  const diff = cost - qs.plannedCost;
  const diffStr = diff === 0 ? "ê³„íšê³¼ ë™ì¼" : diff > 0 ? `+${CONFIG.currency.symbol}${fmt(diff)} over` : `-${CONFIG.currency.symbol}${fmt(Math.abs(diff))} under`;
  showToast(`${qs.eventName}: ${CONFIG.currency.symbol}${fmt(cost)} (${diffStr})`, "âœ…");
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKUP / RESTORE (Feature 1)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportData() {
  const data = {
    version: 1,
    exported: new Date().toISOString(),
    checked: state.checked,
    spending: state.spending,
    budget: state.budget,
    rate: state.rate,
    rateTime: state.rateTime
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `hokkaido-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast("ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ", "ğŸ’¾");
}

function triggerRestore() { document.getElementById("fileRestore").click(); }

function handleRestore(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      // C-2: Validate types before applying
      const valid = {};
      if (data.checked && typeof data.checked === 'object' && !Array.isArray(data.checked)) valid.checked = data.checked;
      if (Array.isArray(data.spending) && data.spending.every(x => typeof x === 'object' && typeof x.cost === 'number' && typeof x.name === 'string')) valid.spending = data.spending;
      if (typeof data.budget === 'number' && data.budget > 0) valid.budget = data.budget;
      if (typeof data.rate === 'number' && data.rate > 0) valid.rate = data.rate;
      if (typeof data.rateTime === 'string') valid.rateTime = data.rateTime;

      if (Object.keys(valid).length === 0) {
        showToast("ë³µì›í•  ìˆ˜ ìˆëŠ” ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", "âš ï¸");
        return;
      }

      if (valid.checked) { state.checked = valid.checked; save(`${SK}-c`, valid.checked); }
      if (valid.spending) { state.spending = valid.spending; save(`${SK}-s`, valid.spending); }
      if (valid.budget) { state.budget = valid.budget; save(`${SK}-b`, valid.budget); }
      if (valid.rate) { state.rate = valid.rate; save(`${SK}-r`, valid.rate); }
      if (valid.rateTime) { state.rateTime = valid.rateTime; save(`${SK}-rt`, valid.rateTime); }
      render();
      showToast("ë°±ì—… ë°ì´í„° ë³µì› ì™„ë£Œ!", "âœ…");
    } catch (err) {
      showToast("ì˜ëª»ëœ ë°±ì—… íŒŒì¼ì…ë‹ˆë‹¤.", "âŒ");
    }
  };
  reader.readAsText(file);
  event.target.value = "";
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SWIPE NAVIGATION (with drag animation)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _swipeStartX = 0, _swipeStartY = 0, _swiping = false, _swipeLocked = false, _swipeDx = 0;
const SWIPE_THRESHOLD = 60;
const SWIPE_MAX_VISUAL = 120;

function initSwipe() {
  const app = document.getElementById("app");

  app.addEventListener("touchstart", (e) => {
    if (state.showBudget) return;
    _swipeStartX = e.touches[0].clientX;
    _swipeStartY = e.touches[0].clientY;
    _swiping = true;
    _swipeLocked = false;
    _swipeDx = 0;
    const inner = document.getElementById("dayContentInner");
    if (inner) { inner.classList.remove("snapping"); inner.style.transform = ""; }
  }, { passive: true });

  app.addEventListener("touchmove", (e) => {
    if (!_swiping || state.showBudget) return;
    const dx = e.touches[0].clientX - _swipeStartX;
    const dy = e.touches[0].clientY - _swipeStartY;

    // Decide scroll direction on first significant move
    if (!_swipeLocked && (Math.abs(dx) > 10 || Math.abs(dy) > 10)) {
      if (Math.abs(dy) > Math.abs(dx) * 0.7) { _swiping = false; return; }
      _swipeLocked = true;
    }
    if (!_swipeLocked) return;

    // Boundary check â€” don't allow swiping past first/last day
    const canLeft = dx < 0 && state.activeDay < DAYS.length - 1;
    const canRight = dx > 0 && state.activeDay > 0;
    if (!canLeft && !canRight) { _swipeDx = 0; updateSwipeVisuals(0); return; }

    // Dampen the drag (rubber band feel)
    const clamped = Math.sign(dx) * Math.min(Math.abs(dx), SWIPE_MAX_VISUAL);
    _swipeDx = dx;

    const inner = document.getElementById("dayContentInner");
    if (inner) inner.style.transform = `translateX(${clamped}px)`;

    updateSwipeVisuals(dx);
  }, { passive: true });

  app.addEventListener("touchend", (e) => {
    if (!_swiping || state.showBudget) { _swiping = false; return; }
    _swiping = false;

    const dx = e.changedTouches[0].clientX - _swipeStartX;
    const inner = document.getElementById("dayContentInner");
    const overlay = document.getElementById("swipeOverlay");

    hideSwipePreviews();
    if (overlay) overlay.classList.remove("dragging");

    if (Math.abs(dx) >= SWIPE_THRESHOLD && _swipeLocked) {
      const direction = dx < 0 ? 1 : -1; // 1 = next, -1 = prev
      const newDay = state.activeDay + direction;
      if (newDay >= 0 && newDay < DAYS.length) {
        // Animate slide out
        if (inner) {
          inner.classList.add("snapping");
          inner.style.transform = `translateX(${-direction * 100}%)`;
          inner.addEventListener("transitionend", function handler() {
            inner.removeEventListener("transitionend", handler);
            state.activeDay = newDay;
            render();
            scrollActiveTab();
            // Slide in from opposite side
            requestAnimationFrame(() => {
              const newInner = document.getElementById("dayContentInner");
              if (newInner) {
                newInner.style.transform = `translateX(${direction * 60}px)`;
                newInner.style.opacity = "0.3";
                requestAnimationFrame(() => {
                  newInner.classList.add("snapping");
                  newInner.style.transform = "translateX(0)";
                  newInner.style.opacity = "1";
                  newInner.addEventListener("transitionend", function h2() {
                    newInner.removeEventListener("transitionend", h2);
                    newInner.classList.remove("snapping");
                    newInner.style.opacity = "";
                  }, { once: true });
                });
              }
            });
          }, { once: true });
          return;
        }
      }
    }

    // Snap back
    if (inner) {
      inner.classList.add("snapping");
      inner.style.transform = "translateX(0)";
      inner.addEventListener("transitionend", function handler() {
        inner.removeEventListener("transitionend", handler);
        inner.classList.remove("snapping");
      }, { once: true });
    }
  }, { passive: true });
}

function updateSwipeVisuals(dx) {
  const overlay = document.getElementById("swipeOverlay");
  const previewLeft = document.getElementById("swipePreviewLeft");
  const previewRight = document.getElementById("swipePreviewRight");
  const absDx = Math.abs(dx);
  const pastThreshold = absDx >= SWIPE_THRESHOLD;

  if (overlay) overlay.classList.toggle("dragging", absDx > 15);

  // Swiping right â†’ show previous day on left
  if (dx > 0 && state.activeDay > 0) {
    const prev = DAYS[state.activeDay - 1];
    document.getElementById("spLeftDay").textContent = `â† Day ${prev.day}`;
    document.getElementById("spLeftTitle").textContent = prev.title;
    previewLeft.classList.toggle("visible", pastThreshold);
    previewRight.classList.remove("visible");
  }
  // Swiping left â†’ show next day on right
  else if (dx < 0 && state.activeDay < DAYS.length - 1) {
    const next = DAYS[state.activeDay + 1];
    document.getElementById("spRightDay").textContent = `Day ${next.day} â†’`;
    document.getElementById("spRightTitle").textContent = next.title;
    previewRight.classList.toggle("visible", pastThreshold);
    previewLeft.classList.remove("visible");
  } else {
    hideSwipePreviews();
  }
}

function hideSwipePreviews() {
  document.getElementById("swipePreviewLeft")?.classList.remove("visible");
  document.getElementById("swipePreviewRight")?.classList.remove("visible");
}

// B-4: scroll active tab into view
function scrollActiveTab() {
  requestAnimationFrame(() => {
    const tab = document.querySelector('.day-tab.active');
    if (tab) tab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  const app = document.getElementById("app");
  if (state.showBudget) { renderBudget(app); return; }
  renderMain(app);
  updateClocks();
}

function renderMain(app) {
  const d = DAYS[state.activeDay];
  const o = OUTFITS[state.activeDay];
  const t0 = CONFIG.travelers[0], t1 = CONFIG.travelers[1];
  const isCouple = o[t0].top === o[t1].top && o[t0].bottom === o[t1].bottom;
  const dt = d.events.reduce((s, e) => s + (e.c || 0), 0);
  const dmIcon = state.darkMode ? "â˜€ï¸" : "ğŸŒ™";

  let h = `
  <div class="header fade-in">
    <div class="header-left">
      <div class="meta">${CONFIG.tripPeriod}</div>
      <div class="title">${CONFIG.tripTitle} ${CONFIG.tripEmoji}</div>
      <div class="sub">${CONFIG.travelers.join(" & ")} Â· ${CONFIG.tripDuration}</div>
    </div>
    <div class="header-right">
      <button class="btn-icon" onclick="toggleDarkMode()" aria-label="${state.darkMode ? 'ë¼ì´íŠ¸ ëª¨ë“œ' : 'ë‹¤í¬ ëª¨ë“œ'}">${dmIcon}</button>
      <button class="btn-primary" onclick="setState({showBudget:true})">ğŸ’° ê°€ê³„ë¶€</button>
    </div>
  </div>

  <div class="clocks">
    ${CONFIG.timezones.map((tz, i) => `
      <div class="clock-card glass">
        <div class="clock-label">${tz.label}</div>
        <div class="clock-time" id="clk${i}">--:--:--</div>
      </div>
    `).join("")}
  </div>

  <div class="day-tabs" role="tablist" aria-label="ì—¬í–‰ ì¼ì • íƒ­">
    ${DAYS.map((x, i) => `
      <div class="day-tab ${state.activeDay === i ? 'active' : ''}" role="tab" tabindex="${state.activeDay === i ? '0' : '-1'}" aria-selected="${state.activeDay === i}" onclick="setState({activeDay:${i}});scrollActiveTab()" onkeydown="handleTabKey(event,${i})">
        <div class="day-tab-num">Day ${x.day}</div>
        <div class="day-tab-date">${x.date} ${x.wd}</div>
      </div>
    `).join("")}
  </div>

  <div class="day-content">
  <div id="dayContentInner" class="day-content-inner">
  <div class="glass day-header fade-in">
    <div>
      <div class="day-title">${d.title}</div>
      <div class="day-sub">${d.date} (${d.wd}) Â· ${d.events.length}ê°œ ì¼ì •</div>
    </div>
    <div class="day-cost">
      <div class="day-yen">${CONFIG.currency.symbol}${fmt(dt)}</div>
      <div class="day-krw">${CONFIG.currency.toSymbol}${fmt(Math.round(dt * state.rate))}</div>
    </div>
  </div>

  <div class="outfit-title">ğŸ‘— OUTFIT ${isCouple ? '<span class="couple-badge">ğŸ’• ì»¤í”Œë£©</span>' : ''}</div>
  <div class="outfit-grid">
    ${CONFIG.travelers.map((nm, idx) => {
      const p = o[nm];
      const icon = idx === 0 ? "ğŸ§‘" : "ğŸ‘©";
      return `<div class="glass outfit-person">
        <div class="outfit-name">${icon} ${nm}</div>
        <div class="outfit-items">
          <div class="outfit-item top">
            <div class="outfit-emoji">${p.te}</div>
            <div class="outfit-label">ìƒì˜</div>
            <div class="outfit-text">${p.top}</div>
          </div>
          <div class="outfit-item bottom">
            <div class="outfit-emoji">${p.be}</div>
            <div class="outfit-label">í•˜ì˜</div>
            <div class="outfit-text">${p.bottom}</div>
          </div>
        </div>
      </div>`;
    }).join("")}
  </div>

  <div class="todo-title">ğŸ“‹ TO DO</div>
  ${d.events.map((ev, i) => {
    const ck = !!state.checked[`${state.activeDay}-${i}`];
    const ac = getActual(state.activeDay, i);
    const diff = (ac !== null && ev.c > 0) ? ac - ev.c : null;
    return `<div class="todo-item ${ck ? 'checked' : 'unchecked'}">
      <div class="checkbox ${ck ? 'on' : 'off'}" role="checkbox" tabindex="0" aria-checked="${ck}" aria-label="${ev.a} ì™„ë£Œ í‘œì‹œ" onclick="toggleCheck(${state.activeDay},${i})" onkeydown="if(event.key===' '||event.key==='Enter'){event.preventDefault();toggleCheck(${state.activeDay},${i})}"></div>
      <div class="todo-time">${ev.t}</div>
      <div class="todo-info">
        <div class="todo-activity">${ev.i} ${ev.a}</div>
        <div class="todo-location">ğŸ“ ${ev.l}</div>
      </div>
      <div class="todo-cost">
        ${ev.c > 0 ? `
          <div>
            <div class="cost-yen ${ev.e ? 'est' : ''}">${CONFIG.currency.symbol}${fmt(ev.c)}${ev.e ? '<span class="cost-est">âš¡</span>' : ''}</div>
            ${diff !== null && diff !== 0 ? `<div class="cost-diff ${diff > 0 ? 'over' : 'under'}">${diff > 0 ? `+${CONFIG.currency.symbol}${fmt(diff)} over` : `-${CONFIG.currency.symbol}${fmt(Math.abs(diff))} under`}</div>` : ''}
          </div>
          <button class="btn-quick-spend" onclick="openQuickSpend(${state.activeDay},${i},event)" aria-label="${ev.a} ì‹¤ì œ ê¸ˆì•¡ ì…ë ¥">${CONFIG.currency.symbol}</button>
        ` : `<div class="cost-free">ë¬´ë£Œ</div>`}
      </div>
    </div>`;
  }).join("")}
  </div>
  </div>
  `;
  app.innerHTML = h;
  updateClocks();
}

function renderBudget(app) {
  const ts = state.spending.reduce((s, x) => s + x.cost, 0);
  const rem = state.budget - ts;
  const tp = DAYS.reduce((s, d) => s + d.events.reduce((a, e) => a + (e.c || 0), 0), 0) + FIXED_TOTAL;
  const pct = state.budget > 0 ? Math.round(ts / state.budget * 100) : 0;
  const pColor = pct > 90 ? "var(--color-over)" : pct > 70 ? "var(--color-est)" : "var(--text-link)";
  const pBg = pct > 90 ? "linear-gradient(90deg,#E88,#D44)" : pct > 70 ? "linear-gradient(90deg,#F0C060,#E8A040)" : `linear-gradient(90deg,var(--btn-gradient-1),var(--btn-gradient-2))`;
  const dmIcon = state.darkMode ? "â˜€ï¸" : "ğŸŒ™";

  let h = `
  <div class="budget-header fade-in">
    <div class="budget-title">ğŸ’° ì—¬í–‰ ê°€ê³„ë¶€</div>
    <div class="budget-actions">
      <button class="btn-icon" onclick="toggleDarkMode()" aria-label="${state.darkMode ? 'ë¼ì´íŠ¸ ëª¨ë“œ' : 'ë‹¤í¬ ëª¨ë“œ'}">${dmIcon}</button>
      <button class="btn-primary" onclick="setState({showBudget:false})">ğŸ“… ì¼ì •ìœ¼ë¡œ</button>
    </div>
  </div>

  <div class="glass rate-bar">
    <div style="display:flex;align-items:center;gap:8px">
      <span class="rate-icon">ğŸ’±</span>
      <div>
        <div class="rate-val">1${CONFIG.currency.symbol} = ${CONFIG.currency.toSymbol}${state.rate.toFixed(2)}</div>
        <div class="rate-time">${state.rateTime}</div>
      </div>
    </div>
    <button class="btn-secondary" onclick="refreshRate()" ${state.rateLoading ? 'disabled' : ''} aria-label="í™˜ìœ¨ ìƒˆë¡œê³ ì¹¨">${state.rateLoading ? 'â³' : 'ğŸ”„ ìƒˆë¡œê³ ì¹¨'}</button>
  </div>

  <div class="summary-grid">
    <div class="summary-card" style="background:var(--card-blue-bg);cursor:pointer" onclick="if(!state.editingBudget)setState({editingBudget:true,budgetInput:String(state.budget)})">
      <div class="summary-label" style="color:var(--text-link)">ì²˜ìŒ ê¸ˆì•¡</div>
      ${state.editingBudget ? `
        <input class="budget-edit-input" id="budgetInput" type="number" value="${state.budgetInput}" oninput="state.budgetInput=this.value" onkeydown="if(event.key==='Enter')saveBudget();if(event.key==='Escape')cancelBudgetEdit()" onblur="setTimeout(saveBudget,150)">
        <div style="display:flex;gap:4px;margin-top:4px;justify-content:center">
          <button class="btn-confirm-budget" onclick="event.stopPropagation();saveBudget()">í™•ì¸</button>
          <button class="btn-confirm-budget" style="background:var(--text-muted)" onclick="event.stopPropagation();cancelBudgetEdit()">ì·¨ì†Œ</button>
        </div>
      ` : `
        <div class="summary-val" style="color:var(--text-link)">${CONFIG.currency.symbol}${fmt(state.budget)}</div>
        <div class="summary-sub" style="color:var(--text-link)">${CONFIG.currency.toSymbol}${fmt(Math.round(state.budget * state.rate))}</div>
        <div class="summary-edit">íƒ­í•˜ì—¬ ìˆ˜ì •</div>
      `}
    </div>
    <div class="summary-card" style="background:var(--card-orange-bg)">
      <div class="summary-label" style="color:var(--color-orange)">ì‚¬ìš© ê¸ˆì•¡</div>
      <div class="summary-val" style="color:var(--color-orange)">${CONFIG.currency.symbol}${fmt(ts)}</div>
      <div class="summary-sub" style="color:var(--color-orange)">${CONFIG.currency.toSymbol}${fmt(Math.round(ts * state.rate))}</div>
    </div>
    <div class="summary-card" style="background:${rem >= 0 ? 'var(--card-green-bg)' : 'var(--card-red-bg)'}">
      <div class="summary-label" style="color:${rem >= 0 ? 'var(--color-under)' : 'var(--color-over)'}">ë‚¨ì€ ê¸ˆì•¡</div>
      <div class="summary-val" style="color:${rem >= 0 ? 'var(--color-under)' : 'var(--color-over)'}">${CONFIG.currency.symbol}${fmt(Math.abs(rem))}</div>
      <div class="summary-sub" style="color:${rem >= 0 ? 'var(--color-under)' : 'var(--color-over)'}">${rem < 0 ? 'âš ï¸ ì´ˆê³¼! ' : ''}${CONFIG.currency.toSymbol}${fmt(Math.round(Math.abs(rem) * state.rate))}</div>
    </div>
  </div>

  <div class="glass progress-wrap">
    <div class="progress-top">
      <span class="progress-label">ì‚¬ìš©ë¥ </span>
      <span class="progress-pct" style="color:${pColor}">${pct}%</span>
    </div>
    <div class="progress-bar"><div class="progress-fill" style="width:${Math.min(100, pct)}%;background:${pBg}"></div></div>
    <div class="progress-note">ê³„íš ì´ì•¡ ${CONFIG.currency.symbol}${fmt(tp)} (${CONFIG.currency.toSymbol}${fmt(Math.round(tp * state.rate))}) Â· ${CONFIG.fixedExpenses.map(fe => `${fe.name} ${CONFIG.currency.symbol}${fmt(fe.cost)}`).join(' + ')} í¬í•¨</div>
  </div>

  <div class="glass input-section">
    <div class="input-title">ğŸ’¸ ì§€ì¶œ ê¸°ë¡</div>
    <div class="input-row">
      <div class="input-row-top">
        <select class="input-select" onchange="state.inputDay=Number(this.value)" aria-label="ì¼ì • ì„ íƒ">
          ${DAYS.map(d => `<option value="${d.day}" ${state.inputDay === d.day ? 'selected' : ''}>Day ${d.day}</option>`).join("")}
        </select>
        <input class="input-text" placeholder="í•­ëª©ëª…" value="${escapeHtml(state.inputName)}" oninput="state.inputName=this.value" onkeydown="if(event.key==='Enter')document.getElementById('cInput')?.focus()" aria-label="í•­ëª©ëª…">
      </div>
      <div class="input-row-bottom">
        <input class="input-number" id="cInput" placeholder="${CONFIG.currency.symbol} ê¸ˆì•¡" type="number" value="${escapeHtml(String(state.inputCost))}" oninput="state.inputCost=this.value" onkeydown="if(event.key==='Enter')addSpending()" aria-label="ê¸ˆì•¡">
        <button class="btn-add" onclick="addSpending()">+ ì¶”ê°€</button>
      </div>
    </div>
    <div class="input-hint">ğŸ’¡ TODO í•­ëª© ì˜† ${CONFIG.currency.symbol} ë²„íŠ¼ìœ¼ë¡œ ë¹ ë¥¸ ì…ë ¥ ê°€ëŠ¥!</div>
  </div>

  <div style="font-size:13px;font-weight:700;color:var(--text-primary);margin-bottom:10px">ğŸ“Š ì¼ë³„ ë‚´ì—­</div>
  ${DAYS.map(d => {
    const pl = d.events.reduce((s, e) => s + (e.c || 0), 0);
    const ac = spendByDay(d.day);
    const items = state.spending.filter(x => x.day === d.day);
    const df = ac - pl;
    return `<div class="glass day-budget">
      <div class="day-budget-top" style="margin-bottom:${items.length ? '8' : '0'}px">
        <div>
          <span class="day-budget-label">Day ${d.day}</span>
          <span class="day-budget-title">${d.title}</span>
        </div>
        <div style="text-align:right">
          <div class="day-budget-planned">ê³„íš ${CONFIG.currency.symbol}${fmt(pl)}</div>
          ${ac > 0 ? `<div class="day-budget-actual">ì‹¤ì œ ${CONFIG.currency.symbol}${fmt(ac)}</div>` : ''}
          ${ac > 0 && df !== 0 ? `<div class="day-budget-diff" style="color:${df > 0 ? 'var(--color-over)' : 'var(--color-under)'}">${df > 0 ? `â–² ${CONFIG.currency.symbol}${fmt(df)} over` : `â–¼ ${CONFIG.currency.symbol}${fmt(Math.abs(df))} under`}</div>` : ''}
        </div>
      </div>
      ${items.map(it => `
        <div class="spending-item">
          <span class="spending-name">${escapeHtml(it.name)}</span>
          <div style="display:flex;align-items:center;gap:6px">
            <span class="spending-cost">${CONFIG.currency.symbol}${fmt(it.cost)}</span>
            <span class="spending-krw">${CONFIG.currency.toSymbol}${fmt(Math.round(it.cost * state.rate))}</span>
            <button class="btn-delete ${state.confirmDelete === it.id ? 'confirm' : 'normal'}" onclick="event.stopPropagation();removeSpending('${it.id}')" aria-label="${it.name} ì‚­ì œ">${state.confirmDelete === it.id ? 'í™•ì¸?' : 'âœ•'}</button>
          </div>
        </div>
      `).join("")}
    </div>`;
  }).join("")}

  ${CONFIG.fixedExpenses.map(fe => `
  <div class="fixed-expense-card">
    <div>
      <div class="fixed-expense-label">${fe.emoji} ${fe.name}</div>
      <div class="fixed-expense-sub">${fe.desc}</div>
    </div>
    <div style="text-align:right">
      <div style="font-size:14px;font-weight:700;color:var(--text-primary)">${CONFIG.currency.symbol}${fmt(fe.cost)}</div>
      <div style="font-size:10px;color:var(--text-secondary)">${CONFIG.currency.toSymbol}${fmt(Math.round(fe.cost * state.rate))}</div>
    </div>
  </div>
  `).join("")}

  <div class="glass backup-section">
    <div class="backup-title">ğŸ’¾ ë°ì´í„° ë°±ì—… / ë³µì›</div>
    <div class="backup-btns">
      <button class="btn-secondary" onclick="exportData()">ğŸ“¥ ë°±ì—… ë‹¤ìš´ë¡œë“œ</button>
      <button class="btn-secondary" onclick="triggerRestore()">ğŸ“¤ ë°±ì—… ë³µì›</button>
    </div>
  </div>
  `;
  app.innerHTML = h;
  if (state.editingBudget) {
    const inp = document.getElementById("budgetInput");
    if (inp) { inp.focus(); inp.select(); }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// B-5: keyboard navigation for tabs
function handleTabKey(event, index) {
  let newIndex = index;
  if (event.key === 'ArrowRight' || event.key === 'ArrowDown') {
    event.preventDefault();
    newIndex = Math.min(index + 1, DAYS.length - 1);
  } else if (event.key === 'ArrowLeft' || event.key === 'ArrowUp') {
    event.preventDefault();
    newIndex = Math.max(index - 1, 0);
  } else if (event.key === 'Enter' || event.key === ' ') {
    event.preventDefault();
    setState({ activeDay: index });
    scrollActiveTab();
    return;
  } else {
    return;
  }
  setState({ activeDay: newIndex });
  scrollActiveTab();
  requestAnimationFrame(() => {
    const tabs = document.querySelectorAll('.day-tab');
    if (tabs[newIndex]) tabs[newIndex].focus();
  });
}

// Close modal on overlay click
document.getElementById("quickModal").addEventListener("click", (e) => {
  if (e.target === e.currentTarget) closeQuickSpend();
});

// Enter key for quick spend modal
document.getElementById("qmInput").addEventListener("keydown", (e) => {
  if (e.key === "Enter") submitQuickSpend();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initSnow();
initSwipe();
render();
setInterval(updateClocks, 1000);
refreshRate();

// PWA install prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  showInstallBanner();
});

function showInstallBanner() {
  if (document.querySelector('.install-banner')) return;
  const b = document.createElement('div');
  b.className = 'install-banner';
  b.innerHTML = `
    <div>
      <div class="install-text">${CONFIG.tripEmoji} í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ì‹œê² ì–´ìš”?</div>
      <div class="install-sub">ì•±ì²˜ëŸ¼ ë°”ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆì–´ìš”</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn-install" onclick="installApp()">ì„¤ì¹˜</button>
      <button class="btn-dismiss" onclick="this.parentElement.parentElement.remove()">ë‹«ê¸°</button>
    </div>
  `;
  document.body.appendChild(b);
}

async function installApp() {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  deferredPrompt = null;
  document.querySelector('.install-banner')?.remove();
}
</script>

<!-- PWA Manifest (inline) -->
<script>
const manifest = {
  name: "í™‹ì¹´ì´ë„ ì—¬í–‰ 2026",
  short_name: "í™‹ì¹´ì´ë„",
  description: `${CONFIG.travelers.join(" & ")}ì˜ í™‹ì¹´ì´ë„ ì—¬í–‰`,
  start_url: "./",
  display: "standalone",
  background_color: "#DFF0FB",
  theme_color: "#DFF0FB",
  orientation: "portrait",
  icons: [{
    src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect fill='%23DFF0FB' width='512' height='512' rx='100'/><text x='256' y='300' text-anchor='middle' font-size='280'>â„ï¸</text></svg>",
    sizes: "512x512",
    type: "image/svg+xml",
    purpose: "any maskable"
  }]
};
const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
const link = document.createElement('link');
link.rel = 'manifest';
link.href = URL.createObjectURL(blob);
document.head.appendChild(link);
</script>

<!-- Service Worker (C-4: exclude API from cache) -->
<script>
if ('serviceWorker' in navigator) {
  const swCode = `
    const CACHE = 'hk-v2';
    const API_PATTERNS = ['api.com', 'er-api.com', 'api.exchangerate'];
    self.addEventListener('install', e => { self.skipWaiting() });
    self.addEventListener('activate', e => {
      e.waitUntil(
        caches.keys().then(keys => Promise.all(
          keys.filter(k => k !== CACHE).map(k => caches.delete(k))
        )).then(() => clients.claim())
      );
    });
    self.addEventListener('fetch', e => {
      const url = e.request.url;
      const isApi = API_PATTERNS.some(p => url.includes(p));
      if (isApi) {
        e.respondWith(fetch(e.request).catch(() => new Response('{"error":"offline"}', {headers:{'Content-Type':'application/json'}})));
        return;
      }
      e.respondWith(
        caches.match(e.request).then(r => r || fetch(e.request).then(res => {
          if (res.status === 200) {
            const c = res.clone();
            caches.open(CACHE).then(cache => cache.put(e.request, c));
          }
          return res;
        }).catch(() => caches.match(e.request)))
      );
    });
  `;
  const swBlob = new Blob([swCode], { type: 'application/javascript' });
  const swUrl = URL.createObjectURL(swBlob);
  navigator.serviceWorker.register(swUrl).catch(() => {});
}
</script>
</body>
</html>